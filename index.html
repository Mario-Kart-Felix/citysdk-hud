<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>CitySDK-HUD</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        width: 90%;
        margin: 0px;
        padding: 0px
      }
      #map-canvas {
        float: left;
      }
      #map-controls {
        width: 10%;
        float: right;
      }

    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=drawing"></script>
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://rawgit.com/uscensusbureau/citysdk/master/js/citysdk.js"></script>
    <script type="text/javascript" src="https://rawgit.com/uscensusbureau/citysdk/master/js/citysdk.census.js"></script>
    <script src="https://rawgit.com/esridc/citysdk-arcgis/gh-pages/js/citysdk.arcgis.js" type="text/javascript"></script>
    <script src="js/citysdk.hud.js" type="text/javascript"></script>

    <script>
var polygons = [];
function initialize() {
  var drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.POLYGON,
    drawingControl: true,
    drawingControlOptions: {
      drawingModes: [
        google.maps.drawing.OverlayType.POLYGON,
        google.maps.drawing.OverlayType.RECTANGLE
      ]
    }
  });

  var mapOptions = {
    center: new google.maps.LatLng(40.45535, -79.97553),
    zoom: 13
  };
  var map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

  drawingManager.setMap(map);

  // Listen to click events on the map and add the point to the polygon's path.
  google.maps.event.addListener(drawingManager, 'polygoncomplete',
        function(polygon) {
    findTheData(polygon);
  });
}

/**
 * Queries the City SDK's HUD module using the polygon's path.
 */
function findTheData(polygon) {
  var esriJson = {
    'rings' : [[]],
    'spatialReference': {
      'wkid': 4326
    }
  };
  polygon.getPath().forEach(function(latLng, index) {
    esriJson['rings'][0].push([latLng.lng(), latLng.lat()])
  });

  // Query the City SDK with the esriJson object.
  var request = { 
      "source": "FHA Insurance",
      "geometry": encodeURI(JSON.stringify(esriJson))
  };
  hud.APIRequest(request,function(response) {
      balance = 0;
      loan_count = 0;

      $.map(response.features, function(feature,i) {
          if(feature.attributes['IIF_CNT'] !== null && feature.attributes['IIF_CNT'] !== undefined) {
              loan_count += parseInt(feature.attributes['IIF_CNT']);
              balance += parseInt(feature.attributes['UNPD_BAL_SUM']);
          }
          $('#result-loan').html(loan_count);
          $('#result-balance').html(balance);
      });
      
  });  
}

/**
 * Resets the polygon's path, removing it from the map.
 */
function clearPolygon() {
  polygon.setPath([]);
}

// Initializes the map when the window loads.
google.maps.event.addDomListener(window, 'load', initialize);

var sdk = new CitySDK();
var arcgis = sdk.modules.arcgis;
var hud = sdk.modules.hud;
var balance = 0;
var loan_count = 0;
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <div id="map-controls">
        <input id="data-button" type="button" value="Find the data" onclick="findTheData()"/>
        <input id="clear-button" type="button" value="Clear polygon" onclick="clearPolygon()"/>

        <ul>
            <li>Loan Count: <span id="result-loan"></span></li>
            <li>Unpaid Principle Balance: <span id="result-balance"></span></li>
        </ul>
    </div>        
  </body>
</html>
