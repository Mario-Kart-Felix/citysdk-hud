<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>CitySDK-HUD</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        width: 90%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=drawing"></script>
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://rawgit.com/uscensusbureau/citysdk/master/js/citysdk.js"></script>
    <script type="text/javascript" src="https://rawgit.com/uscensusbureau/citysdk/master/js/citysdk.census.js"></script>
    <script src="https://rawgit.com/esridc/citysdk-arcgis/gh-pages/js/citysdk.arcgis.js" type="text/javascript"></script>
    <script src="js/citysdk.hud.js" type="text/javascript"></script>
        
    <script>
var polygons = [];
function initialize() {
  var drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.POLYGON,
    drawingControl: true,
    drawingControlOptions: {
      drawingModes: [
        google.maps.drawing.OverlayType.POLYGON,
        google.maps.drawing.OverlayType.RECTANGLE
      ]
    }
  });

  var mapOptions = {
    center: new google.maps.LatLng(40.45535, -79.97553),
    zoom: 13
  };
  var map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

  drawingManager.setMap(map);

  // When a polygon or rectangle is complete, issue the data request.
  google.maps.event.addListener(drawingManager, 'polygoncomplete',
        function(polygon) {
    findTheData(polygon.getPath());
  });
  google.maps.event.addListener(drawingManager, 'rectanglecomplete',
        function(rectangle) {
    // Convert 
    var northEast = rectangle.getBounds().getNorthEast();
    var southWest = rectangle.getBounds().getSouthWest();
    var path = new google.maps.MVCArray([
      northEast,
      new google.maps.LatLng(southWest.lat(), northEast.lng()),
      southWest,
      new google.maps.LatLng(northEast.lat(), southWest.lng())]);
    findTheData(path);
  });
}

/**
 * Queries the City SDK's HUD module using the polygon's path.
 */
function findTheData(polygonPath) {
  var esriJson = {
    'rings' : [[]],
    'spatialReference': {
      'wkid': 4326
    }
  };
  polygonPath.forEach(function(latLng, index) {
    esriJson['rings'][0].push([latLng.lng(), latLng.lat()])
  });

  // Query the City SDK with the esriJson object.
  var request = { 
      "source": "FHA Insurance",
      "geometry": encodeURI(JSON.stringify(esriJson))
  };
  hud.APIRequest(request,function(response) {
      balance = 0;
      loan_count = 0;

      $.map(response.features, function(feature,i) {
          if(feature.attributes['IIF_CNT'] !== null && feature.attributes['IIF_CNT'] !== undefined) {
              loan_count += parseInt(feature.attributes['IIF_CNT']);
              balance += parseInt(feature.attributes['UNPD_BAL_SUM']);
          }
          $('#result-loan').html(loan_count);
          $('#result-balance').html(balance);
      });
      
  });  
}

/**
 * Resets the polygon's path, removing it from the map.
 */
function clearPolygon() {
  polygon.setPath([]);
}

// Initializes the map when the window loads.
google.maps.event.addDomListener(window, 'load', initialize);

var sdk = new CitySDK();
var arcgis = sdk.modules.arcgis;
var hud = sdk.modules.hud;
var geometry = {"rings":[[[-79.98167037963867,40.44694705960048],[-79.97119903564453,40.4461632419783],[-79.9801254272461,40.439631072987716],[-79.98458862304688,40.44224401675592]]],"spatialReference":{"wkid":4326}};
var balance = 0;
var loan_count = 0;
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <ul>
        <li>Loan Count: <span id="result-loan"></span></li>
        <li>Unpaid Principle Balance: <span id="result-balance"></span></li>
    </ul>    
  </body>
</html>
