<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>CitySDK-HUD</title>
  <style>
  html,
  body,
  #map-canvas {
    height: 100%;
    width: 100%;
    margin: 0px;
    padding: 0px
  }
  
  #map-canvas {
    height: 600px;
  }
  
  #map-controls {
    font-size: 16px;
  }
  
  .result {
    color: blue;
  }
  
  #instructions {
    color: #888;
  }
  
  #sources,
  #credits,
  #toggle {
    margin-top: 5px;
    border-top: 1px solid #888;
    color: #888;
    position: absolute;
    top: 430px;
  }

  #credits {
    margin-top: 100px;
  }
  
  #toggle {
    margin-top: 200px;
  }
  
  #output {
    display: none;
  }
  </style>
  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/leaflet/0.7.3/leaflet.css" />
  <script src="//cdn.jsdelivr.net/leaflet/0.7.3/leaflet.js"></script>
  <!-- Load Esri Leaflet from CDN -->
  <script src="//cdn.jsdelivr.net/leaflet.esri/1.0.0/esri-leaflet.js"></script>
  <!-- Leaflet Draw -->
  <script src="https://rawgit.com/Leaflet/Leaflet.draw/master/dist/leaflet.draw-src.js"></script>
  <link rel="stylesheet" href="https://rawgit.com/Leaflet/Leaflet.draw/master/dist/leaflet.draw.css">
  <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://rawgit.com/uscensusbureau/citysdk/master/js/citysdk.js"></script>
  <script type="text/javascript" src="https://rawgit.com/uscensusbureau/citysdk/master/js/citysdk.census.js"></script>
  <script src="https://rawgit.com/esridc/citysdk-arcgis/gh-pages/js/citysdk.arcgis.js" type="text/javascript"></script>
  <link href="./bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./bower_components/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet">
  <script src="js/citysdk.hud.js" type="text/javascript"></script>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h3>Demo of CitySDK-HUD</h3>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-8">
        <div id="map-canvas"></div>
      </div>
      <div class="col-lg-4">
        <div id="map-controls">
          <p id="instructions">Draw an area on the map to see...</p>
          <h3>How much is owed?</h3>
          <div id="output">
            There are <span id="result-loan" class="result"></span> loans
            <br /> with a $<span class="result" id="result-balance"></span> unpaid principle balance
            <br /> in an area of <span class="result" id="result-population"></span> people.
          </div>
        </div>
        <div id="sources">
          <strong>Data Sources</strong>
          <ul>
            <li>Powered by <a href="https://github.com/ajturner/citysdk-hud">CitySDK-HUD</a></li>
            <li>US Housing &amp; Urban Development</li>
            <li>US Census via <a href="https://github.com/uscensusbureau/citysdk">CitySDK</a></li>
          </ul>
        </div>
        <div id="credits">
          <strong>Built By</strong>
          <ul>
            <li><a href="http://twitter.com/ajturner">Andrew Turner</a></li>
            <li><a href="https://github.com/sraub">Susannah Raub</a></li>
            <li><a href="https://github.com/jgravois">John Gravois</a></li>
          </ul>
        </div>
        <div id="toggle">
          <strong>Alternate Version</strong>
          <ul>
            <li><a href="google-maps.html">Google Maps</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
  var polygons = [];
  var map;
  var queried;

  $(document).ready(function() {
    map = L.map("map-canvas").setView([40.455, -79.976], 13);
    L.esri.basemapLayer('DarkGray').addTo(map);
    L.esri.basemapLayer('DarkGrayLabels').addTo(map);

    // create a feature group for Leaflet Draw to hook into for delete functionality
    var drawnItems = L.featureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems,
        edit: false // disable the edit tool
      },
      draw: {
        circle: false,
        marker: false,
        polyline: false, // we're only going to allow drawing of boxes and polygons
        polygon: {
          allowIntersection: false, // no self intersections
          drawError: {
            color: 'red', // color the shape will turn if it self intersects
            message: '<strong>Oh snap!<strong> you can\'t draw that!' // message
          },
        }
      }
    });

    // add our drawing controls to the map
    map.addControl(drawControl);

    map.on('draw:created', function(e) {
      var sketch = e.layer.toGeoJSON();
      var esrified = L.esri.Util.geojsonToArcGIS(sketch);
      findTheData(esrified.geometry);
    });

    map.on('draw:drawstart', function(e) {
      // clear old graphics and sidebar
      $("#output").hide();
      if (queried) queried.clearLayers();
    });

  });

  /**
   * Queries the City SDK's HUD module using the polygon's path.
   */
  function findTheData(esriJsonPolygon) {

    // Query the City SDK with the esriJson object.
    var request = {
      "source": "FHA Insurance",
      "geometry": encodeURI(JSON.stringify(esriJsonPolygon))
    };

    hud.APIRequest(request, function(response) {
      $("#output").show()
      balance = 0;
      loan_count = 0;
      var geojson = {
        "type": "FeatureCollection",
        "features": []
      };

      var request = {
        "lat": 42.0,
        "lng": -77.0,
        "level": "blockGroup",
        "container": "state",
        "containerGeometry": esriJsonPolygon,
        "variables": [
          "population"
        ]
      };

      census.APIRequest(request, function(response) {
        $('#result-population').html(response.data[0].population);
      });

      $.map(response.features, function(feature, i) {

        if (feature.attributes['IIF_CNT'] !== null && feature.attributes['IIF_CNT'] !== undefined) {
          loan_count += parseInt(feature.attributes['IIF_CNT']);
          balance += parseInt(feature.attributes['UNPD_BAL_SUM']);
        }

        geojson.features.push(L.esri.Util.arcgisToGeojson(feature));

        $('#result-loan').html(loan_count);
        $('#result-balance').html(balance.formatMoney(2));
      });

      // create a feature group for Leaflet Draw to hook into for delete functionality
      queried = L.featureGroup().addTo(map);
      queried.addLayer(geojsonStyle(geojson));
    });
  }

  function geojsonStyle(data) {
    return L.geoJson(data, {
      style: function(feature) {
        return {
          weight: 2,
          color: 'black',
          fillColor: 'blue',
          fillOpacity: feature.properties.UNPD_BAL_SUM / 6000000
        };
      }
    });
  }

  var sdk = new CitySDK();
  var arcgis = sdk.modules.arcgis;
  var hud = sdk.modules.hud;
  var census = sdk.modules.census;
  census.enable("d9084c5c4a0e92c442406b5eae0f14ec71d83569");

  var balance = 0;
  var loan_count = 0;

  Number.prototype.formatMoney = function(c, d, t) {
    var n = this,
      c = isNaN(c = Math.abs(c)) ? 2 : c,
      d = d == undefined ? "." : d,
      t = t == undefined ? "," : t,
      s = n < 0 ? "-" : "",
      i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "",
      j = (j = i.length) > 3 ? j % 3 : 0;
    return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
  };

  </script>
</body>
</html>
